<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>レグナス時間変換計算機</title>
    <style>
      body {
        margin: 0;
        padding: 12px;
        font-family: "Segoe UI", sans-serif;
        background: #f5f5f5;
        font-size: 16px;
      }
      h3 {
        font-size: 1.2rem;
        margin: 12px 0;
        text-align: center;
      }
      .input-row {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 12px;
      }
      input {
        padding: 10px;
        width: 100%;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
      }
      button {
        padding: 12px;
        font-size: 1rem;
        background-color: #0078d4;
        color: white;
        border: none;
        border-radius: 6px;
        touch-action: manipulation;
      }
      button:active {
        background-color: #005a9e;
      }
      .example-text {
        font-size: 0.85rem;
        color: #555;
        margin-top: 4px;
      }
      #dropzone {
        margin-top: 1em;
        padding: 1.5em;
        font-size: 1rem;
        text-align: center;
        line-height: 1.6;
        color: #555;
        border: 2px dashed #aaa;
        border-radius: 6px;
        background: #f8f8f8;
        transition: background 0.2s, border-color 0.2s;
        cursor: pointer;
      }
      #dropzone.dragover {
        background: #e0f4ff;
        border-color: #339af0;
        color: #000;
      }
      #dropzone input[type="file"] {
        display: none;
      }
      #result-container {
        margin-top: 1em;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #fff;
        border: 1px solid #ccc;
        padding: 12px;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
      }
      #result {
        white-space: pre-wrap;
      }
      #preview img {
        display: block;
        max-width: 100%;
        max-height: 60vh;
        object-fit: contain;
        margin: auto;
      }
      .svg-wrapper {
        text-align: center;
        margin-top: 1em;
      }
      @media screen and (max-width: 600px) {
        input,
        button {
          font-size: 1rem;
        }
        .example-text {
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <h3>
      レグナス時間変換計算機<br>
      -What time was it in Regnas?-
    </h3>

    <div class="input-row">
      <div>
        <input
          id="date"
          placeholder="YYYYMMDD"
          inputmode="numeric"
          oninput="this.value = this.value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                   if (this.value.length === 8) document.getElementById('time').focus();">
        <div class="example-text">例：20240614</div>
      </div>
      <div>
        <input
          id="time"
          placeholder="hhmmss"
          inputmode="numeric"
          oninput="this.value = this.value.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));">
        <div class="example-text">例：151230</div>
      </div>
      <button onclick="convert()">計算</button>
    </div>

    <div id="dropzone" onclick="document.getElementById('fileInput').click()">
      この枠をタップして<br>
      画像ファイルを参照してください。<br>
      形式例:<br>
      BlueProtocol_20240614_151230.png
      <input type="file" id="fileInput">
    </div>

    <div id="result-container">
      <div id="result">結果がここに表示されます</div>
      <div id="preview">プレビュー表示</div>
    </div>

    <script>
      const baseTimeB = new Date(2024, 5, 26, 16, 22, 10);
      const cycleSec = 1500;
      const offsetSec = 750;

      function convert() {
        const dateStr = toHalfWidth(document.getElementById("date").value.trim());
        const timeStr = toHalfWidth(document.getElementById("time").value.trim());

        const match = dateStr.match(/^(\d{4})(\d{2})(\d{2})$/);
        const timeMatch = timeStr.match(/^(\d{2})(\d{2})(\d{2})$/);
        if (!match || !timeMatch) return show("形式は YYYYMMDD と hhmmss です。");

        const inputTime = new Date(+match[1], +match[2] - 1, +match[3], +timeMatch[1], +timeMatch[2], +timeMatch[3]);
        if (isNaN(inputTime.getTime())) return show("指定された日時が無効です。");

        const label = "手入力";
        const mode = inputTime.getTime() < baseTimeB.getTime() ? "A判定" : "B判定";

        if (mode === "A判定") {
          runPhaseConversionA(inputTime, label, mode);
        } else {
          runPhaseConversionB(inputTime, label, mode);
        }
      }

      function toHalfWidth(str) {
        return str.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      }

      function getDynamicBaseTime(dt) {
        const y = dt.getFullYear(), m = dt.getMonth(), d = dt.getDate();
        const nineAM = new Date(y, m, d, 9, 0, 0);
        const base = new Date(nineAM.getTime() - cycleSec * 1000 - offsetSec * 1000);
        return dt < nineAM ? new Date(base.getTime() - 86400000) : base;
      }

      function runPhaseConversionA(inputTime, label, modeLabel) {
        const baseTime = getDynamicBaseTime(inputTime);
        runCoreConversion(inputTime, baseTime, label, modeLabel);
      }

      function runPhaseConversionB(inputTime, label, modeLabel) {
        runCoreConversion(inputTime, baseTimeB, label, modeLabel);
      }

      function runCoreConversion(inputTime, baseTime) {
        const diffSec = Math.floor((inputTime - baseTime) / 1000);
        const cycleIndex = Math.floor(diffSec / cycleSec);
        const offset = diffSec % cycleSec;
        const phase = cycleIndex % 2 === 0 ? "昼" : "夜";
        const mm = String(Math.floor(offset / 60)).padStart(2, "0");
        const ss = String(offset % 60).padStart(2, "0");

        const gauge = `
  <div style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 10px;
              background: ${phase === "昼" ? "#f0fff0" : "#f0f4ff"};
              border-left: 4px solid ${phase === "昼" ? "#7ccf7c" : "#6699cc"};
              border-radius: 6px;">
    <div style="font-size: 1.1rem; font-weight: bold;">
      レグナス時間：<br>${phase} ${mm}分${ss}秒 / 25分00秒
    </div>
    <svg width="60" height="60" viewBox="0 0 120 120">
      <circle cx="60" cy="60" r="50" fill="none" stroke="#eee" stroke-width="10"/>
      <circle
        cx="60" cy="60" r="50"
        fill="none"
        stroke="${phase === "昼" ? "#7ccf7c" : "#6699cc"}"
        stroke-width="10"
        stroke-linecap="butt"
        stroke-dasharray="314"
        stroke-dashoffset="${314 * (1 - offset / cycleSec)}"
        transform="rotate(-90 60 60)"/>
      <text
        x="60" y="68"
        text-anchor="middle"
        font-size="48"
        font-weight="bold"
        fill="${phase === "昼" ? "#4c994c" : "#336699"}"
        font-family="Segoe UI, sans-serif"
        dominant-baseline="middle">
        ${phase}
      </text>
    </svg>
  </div>`;
        show("", gauge);
      }

      function show(text, gaugeHTML = "") {
        document.getElementById("result").textContent = text;
        document.getElementById("preview").innerHTML = gaugeHTML;
      }

      document.getElementById("fileInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;
        const match = file.name.match(/(\d{8})_(\d{6})/);
        if (!match) return show("ファイル名が形式に一致しません。例: BlueProtocol_20240614_151230.png");

        document.getElementById("date").value = match[1];
        document.getElementById("time").value = match[2];
        convert();

        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("preview").innerHTML += `<img src="${e.target.result}" alt="プレビュー">`;
        };
        reader.readAsDataURL(file);
      });
    </script>
  <hr noshade size="1">
  <div align="right">
    BLUE PROTOCOL:<br>©2019 Bandai Namco Online Inc.<br>©2019 Bandai Namco Studios Inc.<br><br>
    レグナス時間変換計算機:<br>
    <a href="https://x.com/Kana_Bananan" target="_blank">ばな奈</a> / 
    <a href="https://github.com/TheDeepBeyond/RegnasTime" target="_blank">GitHub</a> / 
    <a href="index.html">PC版</a>
  </div>
  </body>
</html>
